version: '3.8'

services:
  # PostgreSQL - Unified Database (Metadata, Graph, Vectors)
  postgres:
    build:
      context: ./services/postgres
      dockerfile: Dockerfile
    container_name: nerdlearn-postgres
    environment:
      POSTGRES_USER: nerdlearn
      POSTGRES_PASSWORD: password
      POSTGRES_DB: nerdlearn
    command: postgres -c 'shared_preload_libraries=age' -c 'search_path=ag_catalog,"$user",public'
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U nerdlearn" ]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis - Caching and Session State
  redis:
    image: redis:7-alpine
    container_name: nerdlearn-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 10s
      timeout: 5s
      retries: 5

  # MinIO - Local S3 Storage
  minio:
    image: minio/minio:latest
    container_name: nerdlearn-minio
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    ports:
      - "9000:9000" # API
      - "9001:9001" # Console
    volumes:
      - minio_data:/data
    command: server /data --console-address ":9001"
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:9000/minio/health/live" ]
      interval: 10s
      timeout: 5s
      retries: 5

  # FastAPI Backend
  api:
    build:
      context: ./apps/api
      dockerfile: Dockerfile
    container_name: nerdlearn-api
    environment:
      DATABASE_URL: postgresql+asyncpg://nerdlearn:password@postgres:5432/nerdlearn
      REDIS_URL: redis://redis:6379
      MINIO_ENDPOINT: minio:9000
      MINIO_ACCESS_KEY: minioadmin
      MINIO_SECRET_KEY: minioadmin
    ports:
      - "8010:8000"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      minio:
        condition: service_healthy
    volumes:
      - ./apps/api:/app
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload

  # Celery Worker - Background Processing
  worker:
    build:
      context: ./apps/worker
      dockerfile: Dockerfile
    container_name: nerdlearn-worker
    environment:
      DATABASE_URL: postgresql://nerdlearn:password@postgres:5432/nerdlearn
      REDIS_URL: redis://redis:6379/0
      MINIO_ENDPOINT: minio:9000
      MINIO_ACCESS_KEY: minioadmin
      MINIO_SECRET_KEY: minioadmin
      MINIO_BUCKET: nerdlearn
      MINIO_SECURE: "false"
      OPENAI_API_KEY: ${OPENAI_API_KEY:-your_key_here}
      CHUNK_SIZE: 512
      CHUNK_OVERLAP: 50
      EMBEDDING_MODEL: text-embedding-3-small
      WHISPER_MODEL: base
      VECTOR_SIZE: 1536
      ENABLE_HEAVY_NLP: "true"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      minio:
        condition: service_healthy
    volumes:
      - ./apps/worker:/app
    command: celery -A app.celery_app worker --loglevel=info --concurrency=2

  # Next.js Frontend
  web:
    build:
      context: ./apps/web
      dockerfile: Dockerfile
    container_name: nerdlearn-web
    environment:
      NEXT_PUBLIC_API_URL: http://localhost:8010
      NEXT_PUBLIC_TELEMETRY_URL: ws://localhost:8012
      API_URL: http://api:8000 # For server-side rewrites
    ports:
      - "3011:3000"
    depends_on:
      - api
    volumes:
      - ./apps/web:/app
      - /app/node_modules
      - /app/.next
    command: npm run dev

  # Telemetry Service - Real-time Behavioral Analytics
  telemetry:
    build:
      context: ./services/telemetry
      dockerfile: Dockerfile
    container_name: nerdlearn-telemetry
    environment:
      REDIS_URL: redis://redis:6379/1
    ports:
      - "8012:8002"
    depends_on:
      redis:
        condition: service_healthy
    volumes:
      - ./services/telemetry:/app
    command: uvicorn main:app --host 0.0.0.0 --port 8002 --reload

  # Orchestrator Service - Learning Flow Controller
  orchestrator:
    build:
      context: ./services/orchestrator
      dockerfile: Dockerfile
    container_name: nerdlearn-orchestrator
    environment:
      DATABASE_URL: postgresql://nerdlearn:password@postgres:5432/nerdlearn
      SCHEDULER_URL: http://scheduler:8000
      TELEMETRY_URL: http://telemetry:8002
      INFERENCE_URL: http://inference:8000
      CONTENT_URL: http://content:8000
      REDIS_URL: redis://redis:6379/0
    ports:
      - "8015:8000"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    volumes:
      - ./services/orchestrator:/app
    command: uvicorn main:app --host 0.0.0.0 --port 8000 --reload

  # Scheduler Service - Spaced Repetition Engine
  scheduler:
    build:
      context: ./services/scheduler
      dockerfile: Dockerfile
    container_name: nerdlearn-scheduler
    environment:
      DATABASE_URL: postgresql://nerdlearn:password@postgres:5432/nerdlearn
      REDIS_URL: redis://redis:6379/0
    ports:
      - "8011:8000"
    volumes:
      - ./services/scheduler:/app
    command: uvicorn main:app --host 0.0.0.0 --port 8000 --reload

  # Inference Service - Knowledge Tracing (BKT/DKT)
  inference:
    build:
      context: ./services/inference
      dockerfile: Dockerfile
    container_name: nerdlearn-inference
    environment:
      DATABASE_URL: postgresql://nerdlearn:password@postgres:5432/nerdlearn
    ports:
      - "8013:8000"
    volumes:
      - ./services/inference:/app
    command: uvicorn main:app --host 0.0.0.0 --port 8000 --reload

  # Content Service - Ingestion and Management
  content:
    build:
      context: ./services/content-ingestion
      dockerfile: Dockerfile
    container_name: nerdlearn-content
    environment:
      DATABASE_URL: postgresql://nerdlearn:password@postgres:5432/nerdlearn
      MINIO_ENDPOINT: minio:9000
      MINIO_ACCESS_KEY: minioadmin
      MINIO_SECRET_KEY: minioadmin
    ports:
      - "8014:8000"
    volumes:
      - ./services/content-ingestion:/app
    command: uvicorn main:app --host 0.0.0.0 --port 8000 --reload

volumes:
  postgres_data:
  redis_data:
  minio_data:


networks:
  default:
    name: nerdlearn-network
